import logging
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,
    ConversationHandler,
)

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)

# –≠—Ç–∞–ø—ã –¥–∏–∞–ª–æ–≥–∞
ANSWER = range(1)

# –í–æ–ø—Ä–æ—Å—ã –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
quiz = [
    {
        "q": "1. –ß—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –ø–æ—Å–ª–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è?",
        "options": [
            ("‚òÄÔ∏è –°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∏ —Ä–∞–¥–æ—Å—Ç—å –æ—Ç –Ω–æ–≤–æ–≥–æ –¥–Ω—è", 1),
            ("üòê –ù–∏—á–µ–≥–æ, –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–∏–Ω–∞—é –¥–µ–ª–∞", 2),
            ("üò£ –•–æ—á–µ—Ç—Å—è –µ—â—ë –ª–µ–∂–∞—Ç—å –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å", 3),
        ],
    },
    {
        "q": "2. –í—Å–ø–æ–º–Ω–∏ –ø—Ä–æ—à–µ–¥—à—É—é –Ω–µ–¥–µ–ª—é, –∫–∞–∫ –±—ã —Ç—ã –æ—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑–æ–≤–∞–ª(–∞) —Å–≤–æ—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?",
        "options": [
            ("üòä –†–æ–≤–Ω–æ–µ –∏–ª–∏ –ø—Ä–∏–ø–æ–¥–Ω—è—Ç–æ–µ", 1),
            ("üòï –ù–µ–±–æ–ª—å—à–∏–µ –ø–µ—Ä–µ–ø–∞–¥—ã", 2),
            ("üò´ –ß–∞—â–µ —Ç—è–∂—ë–ª–æ–µ, —á–µ–º –ª—ë–≥–∫–æ–µ", 3),
        ],
    },
    {
        "q": "3. –ü—Ä–µ–¥—Å—Ç–∞–≤—å —á—Ç–æ —É —Ç–µ–±—è –ø–æ—è–≤–∏–ª–∏—Å—å —Å–≤–æ–±–æ–¥–Ω—ã–µ 30 –º–∏–Ω—É—Ç. –ù–∞ —á—Ç–æ —Ç—ã –∏—Ö –ø–æ—Ç—Ä–∞—Ç–∏—à—å?",
        "options": [
            ("üìñ –û—Ç–¥–æ—Ö–Ω—É —Ç–∞–∫, –∫–∞–∫ —Ö–æ—á—É (–∫–Ω–∏–≥–∞, –º—É–∑—ã–∫–∞, –ø—Ä–æ–≥—É–ª–∫–∞)", 1),
            ("üì± –ë—É–¥—É –ª–∏—Å—Ç–∞—Ç—å —Å–æ—Ü—Å–µ—Ç–∏ –±–µ–∑ –æ—Å–æ–±–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞", 2),
            ("ü´† –û—Ç–ª–æ–∂—É –≤—Å–µ –¥–µ–ª–∞ –∏ –±—É–¥—É –ª–µ–∂–∞—Ç—å –±–µ–∑ —Å–∏–ª", 3),
        ],
    },
    {
        "q": "4. –ö–∞–∫ —Ç—ã —Ä–µ–∞–≥–∏—Ä—É–µ—à—å –Ω–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –º–µ–ª–∫–∏–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏?",
        "options": [
            ("üôÇ –°–æ—Ö—Ä–∞–Ω—è—é —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, —Ä–µ—à–∞—é –≤–æ–ø—Ä–æ—Å", 1),
            ("üòê –ù–µ–º–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–≥–∞–µ—Ç, –Ω–æ —Å–ø—Ä–∞–≤–ª—è—é—Å—å", 2),
            ("üò§ –û—á–µ–Ω—å —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç –∏–ª–∏ –≤—ã–±–∏–≤–∞–µ—Ç –∏–∑ –∫–æ–ª–µ–∏", 3),
        ],
    },
    {
        "q": "5. –ù–∞—Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–æ —Ç–µ–±–µ —Ö–æ—Ç–µ–ª–æ—Å—å —á—Ç–æ-—Ç–æ —Å—Ä–æ—á–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –≤ —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏?",
        "options": [
            ("üåø –†–µ–¥–∫–æ, –º–µ–Ω—è –≤ —Ü–µ–ª–æ–º –≤—Å—ë —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç", 1),
            ("ü§î –ò–Ω–æ–≥–¥–∞ –ø–æ—è–≤–ª—è—é—Ç—Å—è —Ç–∞–∫–∏–µ –º—ã—Å–ª–∏", 2),
            ("üîÑ –û—á–µ–Ω—å —á–∞—Å—Ç–æ —Ö–æ—á–µ—Ç—Å—è –≤—Å—ë –±—Ä–æ—Å–∏—Ç—å –∏–ª–∏ –ø–æ–º–µ–Ω—è—Ç—å", 3),
        ],
    },
    {
        "q": "6. –ö–∞–∫ —É —Ç–µ–±—è —Å –ø—Ä–∏–≤—ã—á–Ω—ã–º–∏ –¥–µ–ª–∞–º–∏ (—É—á—ë–±–∞, —Ä–∞–±–æ—Ç–∞, –¥–æ–º–∞—à–Ω–∏–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏)?",
        "options": [
            ("üìù –í—ã–ø–æ–ª–Ω—è—é –∏—Ö –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –≤ –ø—Ä–∏–≤—ã—á–Ω–æ–º —Ä–∏—Ç–º–µ", 1),
            ("üòê –ò–Ω–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –∑–∞—Å—Ç–∞–≤–ª—è—Ç—å —Å–µ–±—è", 2),
            ("üò´ –ü–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ —Ç—è–∂–µ–ª–æ –¥–∞–∂–µ –Ω–∞—á–∞—Ç—å", 3),
        ],
    },
    {
        "q": "7. –ß—Ç–æ —Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ —á—É–≤—Å—Ç–≤—É–µ—à—å –ø—Ä–∏ –æ–±—â–µ–Ω–∏–∏ —Å –¥—Ä—É–≥–∏–º–∏ –ª—é–¥—å–º–∏?",
        "options": [
            ("ü´Ç –ò–Ω—Ç–µ—Ä–µ—Å –∏ —Ç–µ–ø–ª–æ", 1),
            ("üò∂ –ü—Ä–æ—Å—Ç–æ –æ–±—â–µ–Ω–∏–µ ¬´–ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏¬ª", 2),
            ("üö™ –•–æ—á–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ –∑–∞–∫–æ–Ω—á–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä", 3),
        ],
    },
    {
        "q": "8. –ï—Å–ª–∏ —Å—Ä–∞–≤–Ω–∏—Ç—å —Ç–≤–æ—é —ç–Ω–µ—Ä–≥–∏—é —Å ¬´–±–∞—Ç–∞—Ä–µ–π–∫–æ–π¬ª, –∫–∞–∫–∏–º –±—ã —Å–µ–π—á–∞—Å –±—ã–ª –µ—ë –∑–∞—Ä—è–¥?",
        "options": [
            ("üîã –ü–æ—á—Ç–∏ –ø–æ–ª–Ω–∞—è (70‚Äì100%)", 1),
            ("üîã –ù–∞–ø–æ–ª–æ–≤–∏–Ω—É (40‚Äì70%)", 2),
            ("üîã –ü–æ—á—Ç–∏ —Ä–∞–∑—Ä—è–∂–µ–Ω–∞ (0‚Äì40%)", 3),
        ],
    },
    {
        "q": "9. –ß—Ç–æ –ø–µ—Ä–≤—ã–º –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –≥–æ–ª–æ–≤—É –ø—Ä–∏ –º—ã—Å–ª–∏ –æ –±–ª–∏–∂–∞–π—à–µ–π –Ω–µ–¥–µ–ª–µ?",
        "options": [
            ("‚ú® –õ—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ, –æ–∂–∏–¥–∞–Ω–∏–µ", 1),
            ("üòê –í—Å—ë —Ä–∞–≤–Ω–æ, ¬´–∫–∞–∫ –ø–æ–π–¥—ë—Ç¬ª", 2),
            ("üò£ –¢—è–∂–µ—Å—Ç—å –∏ –Ω–µ–∂–µ–ª–∞–Ω–∏–µ", 3),
        ],
    },
    {
        "q": "10. –ß—Ç–æ —Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ –æ—â—É—â–∞–µ—à—å –ø–µ—Ä–µ–¥ —Å–Ω–æ–º?",
        "options": [
            ("üõè –°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–æ—Å—Ç—å", 1),
            ("üòï –°—É–µ—Ç–∞ –≤ –º—ã—Å–ª—è—Ö, –Ω–æ —É–¥–∞—ë—Ç—Å—è —É—Å–Ω—É—Ç—å", 2),
            ("üò´ –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ, —Ç—è–∂—ë–ª—ã–µ –º—ã—Å–ª–∏, –¥–æ–ª–≥–æ –≤–æ—Ä–æ—á–∞—é—Å—å", 3),
        ],
    },
]

# –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
user_data = {}


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    user_data[chat_id] = {"score": 0, "current_q": 0}

    await update.message.reply_text(
        "üëã –ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π –ø—Ä–æ–≤–µ—Ä–∏–º —Ç–≤–æ–π —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞!\n\n"
        "–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –≤—ã–±–∏—Ä–∞—è –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç."
    )

    return await ask_question(update, context)


async def ask_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    data = user_data[chat_id]
    q_num = data["current_q"]

    if q_num < len(quiz):
        q_data = quiz[q_num]
        options = [o[0] for o in q_data["options"]]

        reply_markup = ReplyKeyboardMarkup(
            [options], resize_keyboard=True, one_time_keyboard=True
        )

        await update.message.reply_text(q_data["q"], reply_markup=reply_markup)
        return ANSWER
    else:
        return await finish(update, context)


async def handle_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    data = user_data[chat_id]
    q_num = data["current_q"]

    chosen = update.message.text
    score = 0

    # –∏—â–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    for opt_text, opt_score in quiz[q_num]["options"]:
        if chosen == opt_text:
            score = opt_score

    if score == 0:  # –µ—Å–ª–∏ –≤–≤–µ–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–æ
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç —Å –∫–Ω–æ–ø–∫–∏.")
        return ANSWER

    data["score"] += score
    data["current_q"] += 1
    user_data[chat_id] = data

    if data["current_q"] < len(quiz):
        return await ask_question(update, context)
    else:
        return await finish(update, context)


async def finish(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    score = user_data[chat_id]["score"]

    if 10 <= score <= 16:
        result = "üåø –ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞: –û—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π –∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Å–µ–±–µ ü´Ç"
    elif 17 <= score <= 23:
        result = "üå• –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞: –£–¥–µ–ª—è–π –±–æ–ª—å—à–µ –≤–Ω–∏–º–∞–Ω–∏—è –æ—Ç–¥—ã—Ö—É! ü´Ç"
    else:
        result = "üö® –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞: –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø–æ–≥–æ–≤–æ—Ä–∏ —Å –±–ª–∏–∑–∫–∏–º–∏ –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º ü´Ç"

    await update.message.reply_text(
        f"‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!\n–¢–≤–æ–∏ –±–∞–ª–ª—ã: {score}\n\n{result}"
    )

    return ConversationHandler.END


def main():
    import os

    TOKEN ="8331858917:AAF8HRI3UDe7bN050PNHI215LnhH939Dk44"
    app = ApplicationBuilder().token(TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={ANSWER: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_answer)]},
        fallbacks=[CommandHandler("start", start)],
    )

    app.add_handler(conv_handler)
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    app.run_polling()


if __name__ == "__main__":
    main()
